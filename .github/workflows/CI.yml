# .github/workflows/CI.yml
name: CI

on:
  push:
    branches: [master]
    tags: ['*']
  pull_request:

jobs:
  test:
    name: CI
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        version: ['1.10', '1']
        os: [ubuntu-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: julia-actions/setup-julia@v2
        with:
          version: ${{ matrix.version }}
      - uses: julia-actions/cache@v2
      - uses: julia-actions/julia-buildpkg@v1
      - uses: julia-actions/julia-runtest@v1
      
  # Test Python build can extract version
  test-python-version:
    name: Python Version Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      # ✅ Install the package (brings all dependencies)
      - name: Install package
        run: pip install -e python/
      
      - name: Verify version
        run: python -c "import chen; print(f'chen v{chen.__version__}')"
      
      - name: Verify version matches Project.toml
        run: |
          python << 'EOF'
          import re
          from pathlib import Path
          import chen
          
          # Read Julia version
          project_toml = Path('Project.toml')
          content = project_toml.read_text()
          match = re.search(r'version = "([^"]+)"', content)
          julia_version = match.group(1)
          
          # Compare
          assert chen.__version__ == julia_version, \
              f"Version mismatch: Python={chen.__version__}, Julia={julia_version}"
          
          print(f"✓ Versions match: {julia_version}")
          EOF