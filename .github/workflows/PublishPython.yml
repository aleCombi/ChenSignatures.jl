# .github/workflows/PublishPython.yml
name: Publish Python Package

on:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      # Wait for Julia General registry to sync
      - name: Verify Julia package is available
        run: |
          julia -e '
            using Pkg
            version = "${{ steps.version.outputs.version }}"
            
            # Try to resolve the package
            Pkg.Registry.update()
            
            for i in 1:20
              try
                Pkg.add(name="ChenSignatures", version=version)
                println("✅ ChenSignatures@$version is available")
                exit(0)
              catch e
                if i == 20
                  println("❌ ChenSignatures@$version not in General registry after 10 minutes")
                  exit(1)
                end
                println("⏳ Waiting for registry sync... (attempt $i/20)")
                sleep(30)
              end
            end
          '
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install build tools
        run: pip install build twine
      
      - name: Build package
        working-directory: python
        env:
          CHEN_VERSION: ${{ steps.version.outputs.version }}
        run: python -m build
      
      - name: Publish to PyPI
        working-directory: python
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
        run: twine upload dist/*