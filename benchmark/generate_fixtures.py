# generate_fixtures.py
import numpy as np
import iisignature
from pathlib import Path

# Import shared utilities
from common import make_path, SCRIPT_DIR

def fmt_array(arr):
    # Format numpy array as a Julia Vector
    # Use high precision
    items = [f"{x:.17e}" for x in arr.ravel()]
    return "[" + ", ".join(items) + "]"

def generate():
    # Determine output path: ../test/fixtures.jl relative to this script
    output_path = SCRIPT_DIR.parent / "test" / "fixtures.jl"
    
    print(f"Generating fixtures to: {output_path}")
    
    with open(output_path, "w", encoding="utf-8") as f:
        def w(text=""):
            f.write(text + "\n")

        w("# This file is auto-generated by benchmark/generate_fixtures.py")
        w("# Do not edit manually.")
        w("module Fixtures")
        w()
        
        # Configuration for the snapshot
        N = 10
        configs = [
            (2, 4, "linear"),
            (2, 4, "sin"),
            (3, 3, "linear"),
        ]

        w(f"const N = {N}")
        w()

        for d, m, kind in configs:
            path = make_path(d, N, kind)
            
            # 1. Signature
            sig = iisignature.sig(path, m)
            name_sig = f"SIG_D{d}_M{m}_{kind.upper()}"
            w(f"const {name_sig} = {fmt_array(sig)}")

            # 2. Log Signature (Lyndon Basis)
            # Note: iisignature.logsig requires prepared basis for correctness
            basis = iisignature.prepare(d, m)
            logsig = iisignature.logsig(path, basis)
            name_log = f"LOGSIG_D{d}_M{m}_{kind.upper()}"
            w(f"const {name_log} = {fmt_array(logsig)}")
            w()

        w("end # module")
    
    print("Done.")

if __name__ == "__main__":
    generate()