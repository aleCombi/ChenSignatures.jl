# utils/generate_fixtures.py
import numpy as np
import iisignature
import math
from pathlib import Path

def make_path_linear(d: int, N: int) -> np.ndarray:
    ts = np.linspace(0.0, 1.0, N)
    path = np.empty((N, d), dtype=float)
    path[:, 0] = ts
    if d > 1:
        path[:, 1:] = 2.0 * ts[:, None]
    return path

def make_path_sin(d: int, N: int) -> np.ndarray:
    ts = np.linspace(0.0, 1.0, N)
    omega = 2.0 * math.pi
    ks = np.arange(1, d + 1, dtype=float)
    path = np.sin(omega * ts[:, None] * ks[None, :])
    return path

def fmt_array(arr):
    # Format numpy array as a Julia Vector
    # Use high precision
    items = [f"{x:.17e}" for x in arr.ravel()]
    return "[" + ", ".join(items) + "]"

def generate():
    # Determine output path: ../test/fixtures.jl relative to this script
    script_dir = Path(__file__).resolve().parent
    output_path = script_dir.parent / "test" / "fixtures.jl"
    
    print(f"Generating fixtures to: {output_path}")
    
    with open(output_path, "w", encoding="utf-8") as f:
        def w(text=""):
            f.write(text + "\n")

        w("# This file is auto-generated by utils/generate_fixtures.py")
        w("# Do not edit manually.")
        w("module Fixtures")
        w()
        
        # Configuration for the snapshot
        N = 10
        configs = [
            (2, 4, "linear", make_path_linear),
            (2, 4, "sin", make_path_sin),
            (3, 3, "linear", make_path_linear),
        ]

        w(f"const N = {N}")
        w()

        for d, m, kind, func in configs:
            path = func(d, N)
            
            # 1. Signature
            sig = iisignature.sig(path, m)
            name_sig = f"SIG_D{d}_M{m}_{kind.upper()}"
            w(f"const {name_sig} = {fmt_array(sig)}")

            # 2. Log Signature (Lyndon Basis)
            # Note: iisignature.logsig requires prepared basis for correctness
            basis = iisignature.prepare(d, m)
            logsig = iisignature.logsig(path, basis)
            name_log = f"LOGSIG_D{d}_M{m}_{kind.upper()}"
            w(f"const {name_log} = {fmt_array(logsig)}")
            w()

        w("end # module")
    
    print("Done.")

if __name__ == "__main__":
    generate()